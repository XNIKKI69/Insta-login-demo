<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SwordEX — Expanded Full Version</title>

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- React and ReactDOM CDN -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<script type="module">
// ================= Firebase Setup =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

// ===== Firebase config =====
const firebaseConfig = {
  apiKey: "AIzaSyBoco0HmEDwL8ffXt5UJgWJgDyz2KghcFU",
  authDomain: "swordex-login.firebaseapp.com",
  databaseURL: "https://swordex-login-default-rtdb.firebaseio.com",
  projectId: "swordex-login",
  storageBucket: "swordex-login.appspot.com",
  messagingSenderId: "633212760179",
  appId: "1:633212760179:web:ba64d2b8812ab5c134ba06"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getFirestore(app);
const storage = getStorage(app);

// Expose Firebase utilities globally
window.SWORDEX = {
  auth, provider, db, storage, signInWithPopup, signOut, onAuthStateChanged,
  collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, increment, serverTimestamp,
  ref, uploadBytesResumable, getDownloadURL
};
</script>
</head>
<body class="bg-gray-50 text-gray-900">

<!-- Root container for React -->
<div id="root"></div>

<script>
const { useState, useEffect, useRef } = React;

// ===== Utility function to generate unique ID =====
function uid() {
  return Math.random().toString(36).slice(2, 9);
}

// ================= React Components =================

// ----- Header Component -----
function Header({user, signIn, signOutUser, setView, setProfileView, queryText, setQueryText, view}) {
  return React.createElement('header',{className:'flex justify-between mb-4 items-center'},
    React.createElement('div',{className:'text-2xl font-bold text-rose-600 cursor-pointer'},'SwordEX'),
    React.createElement('div',null,
      React.createElement('input',{
        placeholder:'Search',
        value:queryText,
        onChange:e=>setQueryText(e.target.value),
        className:'border p-1 rounded mr-2'
      }),
      !user?React.createElement('button',{onClick:signIn,className:'bg-rose-600 text-white px-3 py-1 rounded'},'Login'):
      React.createElement('div',{className:'flex gap-2 items-center'},
        React.createElement('div',{className:'cursor-pointer',onClick:()=>setProfileView(user.uid)},user.displayName||user.email),
        React.createElement('button',{onClick:()=>setView('upload'),className:'px-2 py-1 border rounded'},'Upload'),
        React.createElement('button',{onClick:signOutUser,className:'px-2 py-1 border rounded'},'Logout')
      )
    )
  );
}

// ----- Navigation Component -----
function Navigation({view, setView, profileView, setProfileView, user}) {
  return React.createElement('nav',{className:'flex gap-2 mb-4'},
    React.createElement('button',{onClick:()=>{setView('home'); setProfileView(null)},className:`px-3 py-1 rounded ${view==='home'?'bg-rose-600 text-white':''}`},'Home'),
    React.createElement('button',{onClick:()=>{setView('explore'); setProfileView(null)},className:`px-3 py-1 rounded ${view==='explore'?'bg-rose-600 text-white':''}`},'Explore'),
    React.createElement('button',{onClick:()=>setProfileView(user.uid),className:`px-3 py-1 rounded ${profileView?'bg-rose-600 text-white':''}`},'Profile')
  );
}

// ----- Profile Component -----
function Profile({profileUser}) {
  return React.createElement('div',{className:'bg-white p-4 rounded mb-4'},`Profile View: ${profileUser?.displayName||profileUser?.email||'Unknown'}`);
}

// ----- Post Component -----
function Post({post}) {
  const [likes,setLikes] = useState(post.likes||0);
  async function handleLike() {
    const postRef = window.SWORDEX.doc(window.SWORDEX.db,'posts',post.id);
    await window.SWORDEX.updateDoc(postRef,{likes:window.SWORDEX.increment(1)});
    setLikes(likes+1);
  }
  return React.createElement('div',{className:'bg-white rounded p-3 mb-3'},
    React.createElement('div',{className:'font-semibold cursor-pointer'},post.authorName||'Unknown'),
    React.createElement('div',{className:'mt-1 font-medium'},post.title),
    React.createElement('video',{src:post.url,controls:true,className:'w-full h-64 object-cover rounded mt-2'}),
    React.createElement('div',{className:'flex gap-2 mt-2'},
      React.createElement('button',{onClick:handleLike,className:'px-2 py-1 border rounded'},`❤️ ${likes}`),
      React.createElement('span',null,`Comments: ${post.commentsCount||0}`)
    )
  );
}

// ----- Upload Component -----
function Upload({user}) {
  const fileRef = useRef(null);
  async function uploadPost() {
    const file = fileRef.current.files[0];
    const title = document.getElementById('title').value || 'Untitled';
    if(!user) return alert('Login first');
    if(!file) return alert('Select file first');
    const storageRef = window.SWORDEX.ref(window.SWORDEX.storage, `uploads/${uid()}_${file.name}`);
    const uploadTask = window.SWORDEX.uploadBytesResumable(storageRef, file);
    uploadTask.on('state_changed',null,err=>alert('Upload failed: '+err.message),async()=>{
      const url = await window.SWORDEX.getDownloadURL(uploadTask.snapshot.ref);
      await window.SWORDEX.addDoc(window.SWORDEX.collection(window.SWORDEX.db,'posts'), {
        title,url,authorUid:user.uid,authorName:user.displayName||user.email,
        createdAt:window.SWORDEX.serverTimestamp(),likes:0,comments:[],commentsCount:0
      });
      alert('Uploaded!'); document.getElementById('title').value=''; fileRef.current.value=null;
    });
  }
  return React.createElement('div',{className:'bg-white p-4 rounded'},
    React.createElement('h3',{className:'font-semibold mb-2'},'Upload'),
    React.createElement('input',{type:'text',placeholder:'Title',id:'title',className:'w-full border p-1 mb-2'}),
    React.createElement('input',{type:'file',ref:fileRef,className:'mb-2'}),
    React.createElement('div',null,
      React.createElement('button',{onClick:uploadPost,className:'bg-rose-600 text-white px-3 py-1 rounded'},'Upload')
    )
  );
}

// ================= Main App =================
function App() {
  const [user,setUser] = useState(null);
  const [view,setView] = useState('home');
  const [feed,setFeed] = useState([]);
  const [queryText,setQueryText] = useState('');
  const [profileView,setProfileView] = useState(null);

  // Auth listener
  useEffect(()=>{return window.SWORDEX.onAuthStateChanged(window.SWORDEX.auth,u=>setUser(u));},[]);

  // Fetch feed
  useEffect(()=>{
    const q = window.SWORDEX.query(window.SWORDEX.collection(window.SWORDEX.db,'posts'), window.SWORDEX.orderBy('createdAt','desc'));
    const unsub = window.SWORDEX.onSnapshot(q,snap=>{
      const arr=[]; snap.forEach(d=>arr.push({...d.data(),id:d.id})); setFeed(arr);
    });
    return ()=>unsub();
  },[]);

  async function signIn(){try{await window.SWORDEX.signInWithPopup(window.SWORDEX.auth,window.SWORDEX.provider);}catch(e){alert(e.message);}}
  async function signOutUser(){await window.SWORDEX.signOut(window.SWORDEX.auth); setProfileView(null);}

  const filteredFeed = feed.filter(p=>p.title?.toLowerCase().includes(queryText.toLowerCase()) || p.authorName?.toLowerCase().includes(queryText.toLowerCase()));

  return React.createElement('div',{className:'min-h-screen p-4 max-w-5xl mx-auto'},
    React.createElement(Header,{user,signIn,signOutUser,setView,setProfileView,queryText,setQueryText,view}),
    React.createElement(Navigation,{view,setView,profileView,setProfileView,user}),
    profileView && React.createElement(Profile,{profileUser:user}),
    view==='upload' && React.createElement(Upload,{user}),
    view==='home' && filteredFeed.map(p=>React.createElement(Post,{post:p,key:p.id}))
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>
</body>
</html>
