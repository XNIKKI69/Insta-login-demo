<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nova Chat â€” Groups + DMs (No Storage)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0e13;--panel:#0f1720;--muted:#92a3bb;--text:#e8eef7;--brand:#4b8bff;--accent:#7a5cff}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#08101f,#0b1323);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .container{height:100dvh;display:grid;grid-template-columns:280px 1fr}
    @media(max-width:900px){.container{grid-template-columns:1fr}}
    .sidebar{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-right:1px solid rgba(255,255,255,.05)}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .brand{font-weight:800}
    .btn{background:transparent;border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:10px;color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--accent));border:none}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.08);color:#cfe2ff}
    .search{width:100%;padding:9px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.07);background:transparent;color:var(--text)}
    .list{padding:8px;height:calc(100dvh - 170px);overflow:auto}
    .item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
    .item:hover{background:rgba(255,255,255,.04)}
    .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.08)}
    .section{padding:8px 12px;color:var(--muted);font-weight:600}
    .main{display:flex;flex-direction:column;height:100dvh}
    .chatHead{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .chatBody{flex:1;overflow:auto;padding:12px;background:radial-gradient(1200px 400px at 40% -10%, rgba(75,139,255,.14), transparent), linear-gradient(180deg,rgba(255,255,255,.015),rgba(255,255,255,.01))}
    .bubble{max-width:80%;padding:10px;border-radius:12px;margin:8px 0;background:rgba(255,255,255,.05)}
    .me{background:linear-gradient(135deg, rgba(75,139,255,.22), rgba(122,92,255,.16));margin-left:auto}
    .meta{font-size:11px;color:var(--muted);margin-top:4px}
    .chatInput{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,.06)}
    .field{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.07);background:transparent;color:var(--text)}
    .row{display:flex;align-items:center;gap:8px}
    .hide{display:none !important}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <div class="brand">ðŸ’¬ Nova Chat</div>
      <span id="status" class="pill" style="margin-left:10px">Not signed in</span>
    </div>
    <div class="row" id="authControls">
      <button id="btnGoogle" class="btn">Sign in (Google)</button>
      <button id="btnEmail" class="btn">Email</button>
    </div>
    <div class="row hide" id="userBox">
      <img id="uPhoto" class="avatar" alt=""/>
      <div>
        <div id="uName" style="font-weight:600"></div>
        <div id="uEmail" style="font-size:12px;color:#9fb0c8"></div>
      </div>
      <button id="btnLogout" class="btn">Logout</button>
    </div>
  </div>

  <div class="container">
    <aside class="sidebar">
      <div style="padding:10px">
        <input id="search" class="search" placeholder="Search users or groups" />
      </div>

      <div class="section">Direct Messages</div>
      <div id="usersList" class="list"></div>

      <div class="section">Groups</div>
      <div style="padding:0 8px 8px">
        <div class="row">
          <input id="newGroup" placeholder="New group name" class="search" style="height:38px" />
          <button id="btnCreateGroup" class="btn">Create</button>
        </div>
      </div>
      <div id="groupsList" class="list" style="height:calc(100dvh - 290px)"></div>
    </aside>

    <main class="main">
      <div class="chatHead">
        <img id="chatPhoto" class="avatar" alt="" />
        <div>
          <div id="chatTitle" style="font-weight:700">Select a user or group</div>
          <div id="chatSub" class="meta">â€”</div>
        </div>
      </div>
      <div id="chatBody" class="chatBody"></div>
      <div class="chatInput">
        <input id="msgInput" class="field" placeholder="Type a messageâ€¦" />
        <button id="btnSend" class="btn primary">Send</button>
      </div>
    </main>
  </div>

  <script type="module">
    // Firebase SDKs
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, collection, addDoc, onSnapshot, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // ===== Your Firebase Config (provided by you) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBoco0HmEDwL8ffXt5UJgWJgDyz2KghcFU",
      authDomain: "swordex-login.firebaseapp.com",
      databaseURL: "https://swordex-login-default-rtdb.firebaseio.com",
      projectId: "swordex-login",
      storageBucket: "swordex-login.firebasestorage.app",
      messagingSenderId: "633212760179",
      appId: "1:633212760179:web:ba64d2b8812ab5c134ba06"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // UI refs
    const status = document.getElementById('status');
    const authControls = document.getElementById('authControls');
    const userBox = document.getElementById('userBox');
    const uPhoto = document.getElementById('uPhoto');
    const uName = document.getElementById('uName');
    const uEmail = document.getElementById('uEmail');
    const btnGoogle = document.getElementById('btnGoogle');
    const btnEmail = document.getElementById('btnEmail');
    const btnLogout = document.getElementById('btnLogout');

    const usersList = document.getElementById('usersList');
    const groupsList = document.getElementById('groupsList');
    const newGroup = document.getElementById('newGroup');
    const btnCreateGroup = document.getElementById('btnCreateGroup');

    const chatPhoto = document.getElementById('chatPhoto');
    const chatTitle = document.getElementById('chatTitle');
    const chatSub = document.getElementById('chatSub');
    const chatBody = document.getElementById('chatBody');
    const msgInput = document.getElementById('msgInput');
    const btnSend = document.getElementById('btnSend');
    const search = document.getElementById('search');

    // State
    let active = { type:null, id:null, title:null, photo:null, sub:null };
    let unsubMessages = null; // current chat listener

    const avatarOf = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name||'User')}&background=0D1220&color=E8EEF7`;

    // ===== Auth =====
    btnGoogle.onclick = async ()=>{ try{ await signInWithPopup(auth, provider); }catch(e){ alert(e.message); } };
    btnEmail.onclick = async ()=>{
      const email = prompt('Email'); if(!email) return;
      const pass = prompt('Password (new users will be created)'); if(!pass) return;
      try { await signInWithEmailAndPassword(auth,email,pass); }
      catch { const { user } = await createUserWithEmailAndPassword(auth,email,pass); const name = email.split('@')[0]; await updateProfile(user,{displayName:name}); }
    };
    btnLogout.onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      const logged = !!user;
      authControls.classList.toggle('hide', logged);
      userBox.classList.toggle('hide', !logged);
      status.textContent = logged ? 'Online' : 'Not signed in';
      if(!logged){ usersList.innerHTML=''; groupsList.innerHTML=''; chatBody.innerHTML=''; chatTitle.textContent='Select a user or group'; chatSub.textContent='â€”'; if(unsubMessages) unsubMessages(); return; }

      // Ensure profile doc exists
      const uRef = doc(db,'users',user.uid); const snap = await getDoc(uRef);
      if(!snap.exists()) await setDoc(uRef,{ uid:user.uid, name:user.displayName||user.email, email:user.email||'', photo:user.photoURL||'', lastSeen: serverTimestamp(), createdAt: serverTimestamp() });
      else await updateDoc(uRef,{ lastSeen: serverTimestamp(), name: user.displayName||user.email, photo: user.photoURL||'' }).catch(()=>{});

      uPhoto.src = user.photoURL || avatarOf(user.displayName||user.email);
      uName.textContent = user.displayName || user.email;
      uEmail.textContent = user.email || '';

      loadUsers();
      loadGroups();
    });

    // ===== Users (DM list) =====
    function loadUsers(){
      const qUsers = query(collection(db,'users'), limit(100));
      onSnapshot(qUsers,(snap)=>{
        usersList.innerHTML='';
        snap.forEach(d=>{
          const u = d.data();
          if(auth.currentUser && u.uid===auth.currentUser.uid) return; // skip self
          const row = document.createElement('div'); row.className='item'; row.dataset.uid=u.uid;
          row.innerHTML = `<img class='avatar' src='${u.photo||avatarOf(u.name)}'/>`+
            `<div><div style='font-weight:600'>${u.name||'User'}</div><div class='meta'>${u.email||''}</div></div>`;
          row.onclick = ()=> openDM(u);
          usersList.appendChild(row);
        })
      });
    }

    // ===== Groups =====
    btnCreateGroup.onclick = async ()=>{
      const user = auth.currentUser; if(!user) return alert('Sign in first');
      const name = (newGroup.value||'').trim(); if(!name) return alert('Enter group name');
      await addDoc(collection(db,'groups'), { name, owner:user.uid, members:[user.uid], createdAt: serverTimestamp() });
      newGroup.value='';
    };

    function loadGroups(){
      const qGroups = query(collection(db,'groups'), orderBy('createdAt','desc'));
      onSnapshot(qGroups,(snap)=>{
        groupsList.innerHTML='';
        snap.forEach(g=>{
          const d = g.data();
          const row = document.createElement('div'); row.className='item'; row.dataset.gid=g.id;
          row.innerHTML = `<img class='avatar' src='${avatarOf(d.name)}'/>`+
            `<div><div style='font-weight:600'>${d.name}</div><div class='meta'>Members: ${d.members?.length||1}</div></div>`+
            `<div style='margin-left:auto' class='row'><button class='btn pill' data-act='join'>Join</button><button class='btn pill' data-act='open'>Open</button></div>`;
          row.onclick = async (e)=>{
            const actBtn = e.target.closest('button');
            if(!actBtn) return;
            const act = actBtn.dataset.act;
            if(act==='join'){ await joinGroup(g.id); }
            if(act==='open'){ openGroup({ id:g.id, name:d.name }); }
          };
          groupsList.appendChild(row);
        })
      });
    }

    async function joinGroup(gid){
      const ref = doc(db,'groups',gid); const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const d = snap.data();
      const members = new Set(d.members||[]); members.add(auth.currentUser.uid);
      await updateDoc(ref,{ members: Array.from(members) });
      openGroup({ id: gid, name: d.name });
    }

    // ===== Chat open: DM =====
    function openDM(user){
      active = { type:'dm', id: threadId(auth.currentUser.uid,user.uid), title: user.name, photo: user.photo||avatarOf(user.name), sub: user.email||'' };
      renderChatHeader();
      subscribeMessages('dmMessages','threadId', active.id);
    }

    // ===== Chat open: Group =====
    function openGroup(g){
      active = { type:'group', id: g.id, title: g.name, photo: avatarOf(g.name), sub: 'Group' };
      renderChatHeader();
      subscribeMessages('groupMessages','gid', active.id);
    }

    function renderChatHeader(){
      chatPhoto.src = active.photo || '';
      chatTitle.textContent = active.title || '';
      chatSub.textContent = active.sub || '';
      chatBody.innerHTML='';
      msgInput.focus();
    }

    function threadId(a,b){ return [a,b].sort().join('_'); }

    // ===== Messages subscribe =====
    function subscribeMessages(col, field, value){
      if(unsubMessages) unsubMessages();
      const qMsg = query(collection(db,col), where(field,'==',value), orderBy('createdAt','asc'));
      unsubMessages = onSnapshot(qMsg,(snap)=>{
        chatBody.innerHTML='';
        snap.forEach(m=>{
          const d = m.data();
          const div = document.createElement('div');
          div.className = 'bubble' + (d.uid===auth.currentUser?.uid?' me':'');
          div.innerHTML = `<div>${d.text||''}</div><div class='meta'>${(d.name||'').split(' ')[0]} â€¢ ${new Date(d.createdAt?.toDate?.()||Date.now()).toLocaleTimeString()}</div>`;
          chatBody.appendChild(div);
        });
        chatBody.scrollTop = chatBody.scrollHeight;
      });
    }

    // ===== Send message =====
    btnSend.onclick = sendMessage;
    msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }});

    async function sendMessage(){
      const user = auth.currentUser; if(!user) return alert('Sign in first');
      if(!active.id) return alert('Open a chat first');
      const text = msgInput.value.trim(); if(!text) return;
      const payload = { uid:user.uid, name:user.displayName||user.email, text, createdAt: serverTimestamp() };
      if(active.type==='dm'){
        await addDoc(collection(db,'dmMessages'), { ...payload, threadId: active.id });
      } else {
        await addDoc(collection(db,'groupMessages'), { ...payload, gid: active.id });
      }
      msgInput.value='';
    }

    // ===== Search filter (client-side) =====
    search.addEventListener('input', ()=>{
      const q = search.value.toLowerCase();
      for(const el of [...usersList.children, ...groupsList.children]){
        const t = el.textContent.toLowerCase();
        el.style.display = t.includes(q)?'flex':'none';
      }
    });
  </script>
</body>
</html>
